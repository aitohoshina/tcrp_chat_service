import socket
import sys
import threading 

max_packet_size=4096
def recv_loop(sock: socket.socket):
   while True:
      try:
         data_from_server=sock.recv(max_packet_size)
      except OSError:
         break         
      text_from_server=data_from_server.decode("utf-8","replace")
      print(f'受信内容：{text_from_server}')
      print(">", end="", flush=True)   
def main():
   sock=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
   if len(sys.argv)!=3:
      print(f'例：python3 {sys.argv[0]} <server_ip> <server_port>')
      sys.exit(1)
   server_ip=sys.argv[1]
   try:
      server_port=int(sys.argv[2])
   except ValueError:
      print("<server_port>は整数で入力してください")
      sys.exit(1)
   sock.connect((server_ip,server_port))
   t=threading.Thread(target=recv_loop, args=(sock,), daemon=True)
   t.start()
   while True:
      print("メッセージを入力してください")
      text=input(">")
      if not text:
         continue
      data=text.encode("utf-8")
      sock.send(data)

if __name__ == "__main__":
main()
